# 智能视频行为分析技术方案 (Intelligent Video Behavior Analysis)

本文档详细描述了本项目中实现的**高性能分层级视频分析系统**的技术架构与算法细节。

---

## 1. 核心架构设计 (Core Architecture)

本方案采用 **"漏斗式" (Funnel) 筛选架构**，将视频数据逐层过滤，仅将最有价值的信息传递给昂贵的 VLM (大模型)，从而在保证分析精度的同时极大降低算力与 API 成本。

```mermaid
graph TD
    A[摄像头流/视频文件] --> B(Step 1: ROI & DHash 运动检测 - Local CPU)
    B -- 无变化 (Distance <= 5) --> C[丢弃帧]
    B -- 有变化 (Distance > 5) --> D[关键帧候选]
    D --> E(Step 2: VLM 视觉理解 - Cloud API)
    E --> F[结构化行为日志 (JSON)]
    F --> G(Step 3: LLM 全局汇总 - Cloud API)
    G --> H[最终分析报告 (Markdown)]
```

---

## 2. 详细算法流程

### Step 1: 智能关键帧提取 (Smart Extraction)
**目标**：仅捕获画面中核心人物的有效动作，忽略背景干扰与光照变化。

*   **算法策略**：全流扫描 + ROI 聚焦 + DHash 指纹比对。
*   **具体步骤**：
    1.  **ROI 裁剪 (Region of Interest)**：
        *   自动裁剪画面中心 **50% 区域** (`width*0.5, height*0.5`)。
        *   *目的*：专注分析屏幕前的人物，忽略背景中走动的人员或窗外干扰。
    2.  **DHash 指纹计算 (Difference Hash)**：
        *   将 ROI 缩放为 **9x8** 像素。
        *   转为灰度图。
        *   计算相邻像素梯度（`Pixel[i] > Pixel[i+1]`），生成 **64位二进制指纹**。
        *   *优势*：相比像素差 (Pixel Difference)，DHash 基于结构梯度，**完全不受光照忽明忽暗的影响**。
    3.  **汉明距离筛选 (Hamming Distance)**：
        *   计算当前帧与上一关键帧指纹的汉明距离（异或位数）。
        *   **阈值判断**：若 `Distance > 5`，则判定为发生了显著动作（Effective Motion）。
        *   *效果*：微小的抖动或噪点会被忽略，只有转头、举手等明确动作会被捕获。

### Step 2: 视觉语义理解 (Visual Understanding)
**目标**：将关键帧图像转化为结构化的文本描述。

*   **模型**：`GLM-4v-flash` (多模态大模型)
*   **Prompt 策略**：
    *   **角色设定**：监考员/安全分析员。
    *   **强制聚焦**：指令中明确要求 `仅分析画面正中心的人物的动作。忽略背景和其他人`。
    *   **JSON 输出**：强制模型返回 JSON 格式，包含 `scene`, `objects`, `action` 字段。

### Step 3: 全局行为汇总 (Global Summarization)
**目标**：将碎片化的单帧描述汇总为连贯的行为报告。

*   **模型**：`GLM-4-flash` (文本大模型)
*   **输入**：时间轴形式的 JSON 日志序列。
*   **输出**：结构化中文 Markdown 报告，包含：
    *   **TL;DR** (核心摘要)
    *   **异常行为时间轴** (高亮可疑时刻)
    *   **详细观察**

---

## 3. 性能优势分析

| 指标 | 传统方案 (每秒抽帧) | 本方案 (DHash 触发) | 提升幅度 |
| :--- | :--- | :--- | :--- |
| **无效请求** | 包含大量静止画面 | **0%** (静止时不触发) | ⬇️ 90%+ |
| **抗干扰性** | 弱 (光照变化会导致误报) | **强** (基于梯度结构) | ✅ |
| **计算延迟** | 需上传所有帧 | **毫秒级** (本地过滤) | ⚡️ |
| **成本** | 高 (按帧数计费) | **低** (按动作数计费) | 💰 |

## 4. 代码实现位置

*   **分析器核心**: `backend/app/analyzer.py`
    *   `_dhash()`: 实现了 64位差值哈希算法。
    *   `_extract_keyframes()`: 实现了 ROI 裁剪与汉明距离筛选逻辑。
    *   `analyze()`: 实现了主流程调度。
